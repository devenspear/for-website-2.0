// Character Insights 2.0 - Enterprise-Ready Schema
// Supports: Multi-user, mobile apps, HealthKit integration, audit logging

generator client {
  provider      = "prisma-client-js"
  engineType    = "client"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER & AUTH (Future-ready, single-user for now)
// ============================================

model User {
  id            String   @id @default(cuid())
  email         String?  @unique
  passwordHash  String?

  // Profile
  displayName   String?
  timezone      String   @default("America/New_York")

  // Consent tracking (GDPR/privacy compliance)
  consentedAt   DateTime?
  consentVersion String?  // e.g., "1.0" - track which version they agreed to

  // Onboarding
  isOnboarded   Boolean  @default(false)
  onboardedAt   DateTime?

  // Settings (hidden themes, preferences)
  settings      Json     @default("{}")

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  dailyUsage    DailyUsage[]
  dailyCheckIns DailyCheckIn[]
  dailyScores   DailyScore[]
  weeklyReports WeeklyReport[]
  auditLogs     AuditLog[]
  dataSources   DataSource[]

  @@index([email])
}

// ============================================
// DATA SOURCES (Future HealthKit/sensors)
// ============================================

model DataSource {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  type        String   // "manual", "apple_health", "google_fit", "screen_time_api", "fitbit", etc.
  name        String   // "iPhone 17 Pro", "Apple Watch", etc.
  isActive    Boolean  @default(true)

  // OAuth/API credentials (encrypted in production)
  credentials Json?

  lastSyncAt  DateTime?
  syncStatus  String   @default("never_synced") // "synced", "error", "syncing"

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, type, name])
  @@index([userId])
}

// ============================================
// DAILY DATA
// ============================================

model DailyUsage {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date      DateTime @db.Date

  // Screen time (minutes)
  socialMediaMinutes     Int @default(0)
  shoppingMinutes        Int @default(0)
  entertainmentMinutes   Int @default(0)
  datingAppsMinutes      Int @default(0)
  productivityMinutes    Int @default(0)
  newsMinutes            Int @default(0)
  gamesMinutes           Int @default(0)

  // Behavioral
  phonePickups           Int @default(0)
  lateNightUsageMinutes  Int @default(0)

  // Health
  steps                  Int @default(0)
  sleepHours             Float @default(7.0)
  wakeTime               String @default("07:00")

  // Data source tracking (which device/API provided this)
  source                 String @default("manual") // "manual", "apple_health", etc.

  // Encryption flag for sensitive data
  isEncrypted            Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId, date])
  @@index([date])
}

model DailyCheckIn {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date         DateTime @db.Date

  moodScore    Int      // 1-10
  primaryTheme String   // CharacterTheme enum value
  journalEntry String?  // Encrypted in production

  // Metadata
  source       String   @default("web") // "web", "ios", "android"
  deviceInfo   Json?    // { platform, appVersion, etc. }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId, date])
  @@index([primaryTheme])
}

// ============================================
// CALCULATED SCORES
// ============================================

model DailyScore {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date            DateTime @db.Date

  theme           String
  score           Float    // 0-10
  confidence      Float    // 0-1
  signalBreakdown Json     // Detailed contribution from each signal
  topContributors String[]

  // Scoring algorithm version (for reproducibility)
  algorithmVersion String  @default("1.0")

  createdAt DateTime @default(now())

  @@unique([userId, date, theme])
  @@index([userId, date])
}

model WeeklyReport {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  weekStartDate     DateTime @db.Date
  weekEndDate       DateTime @db.Date

  scores            Json     // ThemeScore[]
  highlights        Json     // ThemeHighlight[]
  reflectivePrompts Json     // GeneratedPrompt[]

  // Trend comparison
  previousWeekId    String?  // Reference to compare trends

  algorithmVersion  String   @default("1.0")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, weekStartDate])
  @@index([userId, weekStartDate])
}

// ============================================
// AUDIT & COMPLIANCE
// ============================================

model AuditLog {
  id          String   @id @default(cuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  action      String   // "data.created", "data.exported", "settings.changed", etc.
  resource    String   // "daily_usage", "check_in", "weekly_report"
  resourceId  String?

  metadata    Json?    // Additional context
  ipAddress   String?
  userAgent   String?

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

// ============================================
// APP CONFIGURATION
// ============================================

model AppConfig {
  id           String   @id @default(cuid())
  key          String   @unique
  value        Json
  description  String?

  updatedAt    DateTime @updatedAt
}
